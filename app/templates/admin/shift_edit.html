{% extends "base.html" %}

{% block content %}
  <section class="card">
    {% include "admin/_sections.html" %}
    <h1>Editar turno</h1>
    <p class="muted">Actualiza nombre u horas esperadas. Los cambios se aplican al turno seleccionado.</p>

    <form method="post">
      {{ form.hidden_tag() }}

      <label for="{{ form.name.id }}">Nombre</label>
      {{ form.name(list="shift-name-suggestions", placeholder="General") }}
      <datalist id="shift-name-suggestions">
        <option value="General"></option>
        <option value="Media jornada"></option>
        <option value="Fin de semana"></option>
      </datalist>

      <div class="inline" style="margin-top: .9rem;">
        {{ form.break_counts_as_worked_bool() }}
        <span>El descanso cuenta como jornada laboral</span>
        <span
          class="help-icon"
          title="En caso de no contar como tiempo laboral se restara del tiempo de trabajo"
          aria-label="Ayuda sobre descanso"
        >?</span>
      </div>

      <label for="{{ form.break_minutes.id }}">Minutos de descanso (Control de pausas)</label>
      {{ form.break_minutes(min=0, step=1) }}

      <label for="{{ form.expected_hours.id }}">Horas trabajadas</label>
      <div style="display:grid; grid-template-columns: minmax(140px, 1fr) minmax(160px, 1fr); gap: .6rem;">
        {{ form.expected_hours(min=0, step="0.25") }}
        {{ form.expected_hours_frequency() }}
      </div>

      <h2 style="margin: 1rem 0 .35rem;">Vacaciones permisos</h2>
      <p class="muted" style="margin-top:0;">
        Define bolsas que podran solicitar los empleados cuando tengan este turno asignado.
      </p>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Numero</th>
              <th>Unidad</th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Accion</th>
            </tr>
          </thead>
          <tbody id="leave-policy-rows">
            {% for row in policy_rows %}
              <tr>
                <td><input type="text" name="policy_name" value="{{ row.name }}" placeholder="Vacaciones"></td>
                <td><input type="number" name="policy_amount" value="{{ row.amount }}" min="0" step="0.25" placeholder="22"></td>
                <td>
                  <select name="policy_unit">
                    {% for unit_value, unit_label in policy_unit_choices %}
                      <option value="{{ unit_value }}" {% if row.unit == unit_value %}selected{% endif %}>{{ unit_label }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td><input type="date" name="policy_valid_from" value="{{ row.valid_from }}"></td>
                <td><input type="date" name="policy_valid_to" value="{{ row.valid_to }}"></td>
                <td><button type="button" class="secondary remove-policy-row">Eliminar</button></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <button type="button" id="add-policy-row" class="secondary" style="margin-top:.55rem;">Anadir vacaciones o permiso</button>

      <template id="leave-policy-template">
        <tr>
          <td><input type="text" name="policy_name" placeholder="Vacaciones"></td>
          <td><input type="number" name="policy_amount" min="0" step="0.25" placeholder="22"></td>
          <td>
            <select name="policy_unit">
              {% for unit_value, unit_label in policy_unit_choices %}
                <option value="{{ unit_value }}">{{ unit_label }}</option>
              {% endfor %}
            </select>
          </td>
          <td><input type="date" name="policy_valid_from" value="{{ policy_default_valid_from }}"></td>
          <td><input type="date" name="policy_valid_to" value="{{ policy_default_valid_to }}"></td>
          <td><button type="button" class="secondary remove-policy-row">Eliminar</button></td>
        </tr>
      </template>

      <div style="margin-top: 1rem;">{{ form.submit() }}</div>
    </form>
  </section>

  <script>
    (function () {
      var rowsContainer = document.getElementById("leave-policy-rows");
      var addButton = document.getElementById("add-policy-row");
      var rowTemplate = document.getElementById("leave-policy-template");
      if (!rowsContainer || !addButton || !rowTemplate) {
        return;
      }

      addButton.addEventListener("click", function () {
        rowsContainer.insertAdjacentHTML("beforeend", rowTemplate.innerHTML.trim());
      });

      rowsContainer.addEventListener("click", function (event) {
        var button = event.target;
        if (!(button instanceof HTMLElement) || !button.classList.contains("remove-policy-row")) {
          return;
        }
        var row = button.closest("tr");
        if (row) {
          row.remove();
        }
      });
    })();
  </script>
{% endblock %}
