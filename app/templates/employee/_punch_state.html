<div id="punch-state" data-current-state="{{ current_state }}">
  <div class="kiosk-clock-wrap">
    <p class="muted">Hora actual</p>
    <div class="kiosk-clock" id="live-clock">--:--:--</div>
  </div>

  <p>
    Estado actual:
    <strong class="status-pill {{ 'status-in' if current_state == 'ENTRADA' else 'status-out' }}">{{ current_state }}</strong>
  </p>

  <div class="actions">
    {% for button in punch_buttons %}
      {% set is_dimmed = (current_state == 'ENTRADA' and button.slug == 'in') or (current_state == 'SALIDA' and button.slug == 'out') %}
      <form
        method="post"
        action="{{ url_for('employee.punch_action', action=button.slug) }}"
        hx-post="{{ url_for('employee.punch_action', action=button.slug) }}"
        hx-target="#punch-state"
        hx-swap="outerHTML"
        onsubmit="return confirmDimmedAction(event, '{{ button.slug }}', {{ 'true' if is_dimmed else 'false' }})"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="confirm_repeat" value="0">
        <button type="submit" class="kiosk-btn {{ button.class }} {% if is_dimmed %}is-dimmed{% endif %}">
          <span class="kiosk-icon">{{ button.icon }}</span>
          {{ button.label }}
        </button>
      </form>
    {% endfor %}
  </div>

  <div class="kiosk-history" style="margin-top: 1rem;">
    <h3 style="margin-bottom: .25rem;">Historial reciente</h3>
    {% if recent_punches %}
      <ul>
        {% for row in recent_punches %}
          <li>{{ row.label }} - {{ row.ts }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">Sin marcajes de entrada/salida hoy.</p>
    {% endif %}
  </div>
</div>

<script>
  (function () {
    function updateClock() {
      const clockEl = document.getElementById("live-clock");
      if (!clockEl) return;
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const ss = String(now.getSeconds()).padStart(2, "0");
      clockEl.textContent = `${hh}:${mm}:${ss}`;
    }

    updateClock();
    if (window.__clockInterval) {
      clearInterval(window.__clockInterval);
    }
    window.__clockInterval = setInterval(updateClock, 1000);
  })();

  function confirmDimmedAction(event, action, isDimmed) {
    if (!isDimmed) {
      return true;
    }

    const stateEl = document.getElementById("punch-state");
    const currentState = stateEl ? stateEl.dataset.currentState : "";

    if (action === "in" && currentState === "ENTRADA") {
      const confirmed = window.confirm("Ya estás en ENTRADA. No deberías pulsar REGISTRAR ENTRADA. ¿Quieres continuar?");
      if (confirmed) {
        const input = event.target.querySelector('input[name="confirm_repeat"]');
        if (input) input.value = "1";
      }
      return confirmed;
    }

    if (action === "out" && currentState === "SALIDA") {
      const confirmed = window.confirm("Ya estás en SALIDA. No deberías pulsar REGISTRAR SALIDA. ¿Quieres continuar?");
      if (confirmed) {
        const input = event.target.querySelector('input[name="confirm_repeat"]');
        if (input) input.value = "1";
      }
      return confirmed;
    }

    return true;
  }
</script>
