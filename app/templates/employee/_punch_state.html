<div id="punch-state" data-current-state="{{ current_state }}">
  <div class="kiosk-toolbar">
    <div class="balance-cards" aria-label="Saldos">
      {% if leave_policy_balances %}
        {% for balance in leave_policy_balances %}
          <article class="balance-card {% if loop.index0 % 3 == 1 %}personal-days{% elif loop.index0 % 3 == 2 %}extra-days{% else %}vacations{% endif %}">
            <div class="balance-card-top">
              <h3>{{ balance.name }}</h3>
              <span class="balance-card-total">{{ balance.total_display }} totales</span>
            </div>
            <p class="balance-card-number">{{ balance.remaining_display }} <span>{{ balance.unit_label }} restantes</span></p>
            <div class="balance-meter"><span style="width:{{ '%.2f'|format(balance.remaining_percent) }}%"></span></div>
            <p class="muted" style="margin:.5rem 0 0;">Usado {{ balance.used_display }} (pendiente {{ balance.pending_display }})</p>
          </article>
        {% endfor %}
      {% else %}
        <article class="balance-card vacations">
          <div class="balance-card-top">
            <h3>Vacaciones permisos</h3>
            <span class="balance-card-total">Sin configurar</span>
          </div>
          <p class="balance-card-number">0 <span>sin bolsas activas</span></p>
          <div class="balance-meter"><span style="width:0%"></span></div>
        </article>
      {% endif %}
    </div>

    <div class="theme-toggle" aria-label="Cambiar tema">
      <button type="button" class="theme-btn" id="theme-toggle-btn" title="Cambiar tema" aria-label="Cambiar tema">
        <span id="theme-toggle-icon" aria-hidden="true"></span>
      </button>
    </div>
  </div>

  <div class="punch-group">
    {% set is_outside = current_state != 'ENTRADA' %}
    <div class="punch-group-header">
      <div class="punch-state-current">
        <span class="state-dot {{ 'is-in' if current_state == 'ENTRADA' else 'is-out' }}" aria-hidden="true"></span>
        <div>
          <span class="muted">Estado actual</span>
          <strong>{{ 'Dentro de jornada' if current_state == 'ENTRADA' else 'Fuera de jornada' }}</strong>
        </div>
      </div>
      <a class="absence-link-inline" href="{{ url_for('employee.me_leaves') }}">Solicitar ausencia</a>
    </div>

    <div class="actions punch-actions">
      {% for button in punch_buttons %}
        {% set is_dimmed = (current_state == 'ENTRADA' and button.slug == 'in') or (current_state == 'SALIDA' and button.slug == 'out') %}
        <form
          method="post"
          action="{{ url_for('employee.punch_action', action=button.slug) }}"
          hx-post="{{ url_for('employee.punch_action', action=button.slug) }}"
          hx-target="#punch-state"
          hx-swap="outerHTML"
          onsubmit="return confirmDimmedAction(event, '{{ button.slug }}', {{ 'true' if is_dimmed else 'false' }})"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="confirm_repeat" value="0">
          <button
            type="submit"
            class="kiosk-btn {{ button.class }} {% if is_dimmed %}is-dimmed{% endif %} {% if is_outside and button.slug == 'in' %}is-highlight-entry{% endif %}"
          >
            <span class="kiosk-icon" aria-hidden="true">
              {% if button.slug == 'in' %}
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8.5 6.5L17 12L8.5 17.5V6.5Z"/>
                </svg>
              {% else %}
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="7.2" y="7.2" width="9.6" height="9.6" rx="1.8" stroke="currentColor" stroke-width="2.1"/>
                </svg>
              {% endif %}
            </span>
            {{ button.label | replace('ENTRADA', 'Entrada') | replace('SALIDA', 'Salida') }}
          </button>
        </form>
      {% endfor %}
    </div>

    <div class="punch-group-tools">
      <button type="button" class="report-btn" id="open-report-modal">
        <span class="report-btn-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 4.7L20 18.4H4L12 4.7Z" stroke="currentColor" stroke-width="1.9" stroke-linejoin="round"/>
            <path d="M12 9.3V13.3" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
            <circle cx="12" cy="15.9" r="1" fill="currentColor"/>
          </svg>
        </span>
        Reportar incidencia
      </button>

      <form
        method="post"
        action="{{ url_for('employee.toggle_pause') }}"
        hx-post="{{ url_for('employee.toggle_pause') }}"
        hx-target="#punch-state"
        hx-swap="outerHTML"
        class="pause-form"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="kiosk-btn punch-pause-btn {% if pause_active %}resume{% else %}pause{% endif %}">
          <span class="kiosk-icon" aria-hidden="true">
            {% if pause_active %}
              <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M8.5 6.5L17 12L8.5 17.5V6.5Z"/>
              </svg>
            {% else %}
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6.5 8.3H13.2V12.8C13.2 14.6 11.8 16 10 16H9.7C7.9 16 6.5 14.6 6.5 12.8V8.3Z" stroke="currentColor" stroke-width="1.9" stroke-linejoin="round"/>
                <path d="M13.2 9.5H15.6C16.4 9.5 17 10.1 17 10.9C17 11.7 16.4 12.3 15.6 12.3H13.2" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5.5 17.8H14.3" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
              </svg>
            {% endif %}
          </span>
          {% if pause_active %}Finalizar pausa{% else %}Iniciar pausa{% endif %}
        </button>
      </form>
    </div>

    <div class="punch-group-meta">
      {% if pause_active %}
        <p>Tiempo en Pausa: <strong id="pause-live-time">{{ running_pause_time }}</strong></p>
      {% endif %}
      <p>Pausas hoy: <strong>{{ paused_today }}</strong></p>
    </div>
  </div>

  <div class="kiosk-history">
    <div class="kiosk-history-head">
      <h3>
        <span class="history-title-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="12" r="8.5" stroke="currentColor" stroke-width="1.9"/>
          </svg>
        </span>
        Historial reciente
      </h3>
      <a href="{{ url_for('employee.presence_control') }}">Ver todo</a>
    </div>
    {% if recent_punches %}
      <ul class="history-feed">
        {% for row in recent_punches %}
          {% set is_in = 'Entrada' in row.label %}
          <li class="history-feed-item">
            <span class="history-event-icon {{ 'is-in' if is_in else 'is-out' }}" aria-hidden="true">
              {% if is_in %}
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8.5 6.5L17 12L8.5 17.5V6.5Z"/>
                </svg>
              {% else %}
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <rect x="7.4" y="7.4" width="9.2" height="9.2" rx="1.7"/>
                </svg>
              {% endif %}
            </span>
            <div class="history-feed-left">
              <div>
                <strong>{{ row.label }}</strong>
                <span>Hoy{{ row.manual }}</span>
              </div>
            </div>
            <div class="history-feed-right">
              <strong>{{ row.ts }}</strong>
              <span>Registrado</span>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">Sin marcajes de entrada/salida hoy.</p>
    {% endif %}
  </div>
</div>

<div class="report-modal" id="report-modal" aria-hidden="true">
  <div class="report-modal-content" role="dialog" aria-modal="true" aria-labelledby="report-modal-title">
    <div class="report-modal-header">
      <h3 id="report-modal-title" style="margin: 0;">Reportar incidencia</h3>
      <button type="button" class="close-modal-btn" id="close-report-modal" aria-label="Cerrar ventana">✕</button>
    </div>

    <button type="button" class="incident-type-btn manual" data-form-target="manual-form">Me he olvidado fichar</button>
    <div class="incident-form" id="manual-form">
      <form method="post" action="{{ url_for('employee.create_manual_punch') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <label for="manual-date">Fecha del fichaje</label>
      <input type="date" id="manual-date" name="manual_date" required>

      <div class="actions" style="margin-top: .5rem;">
        <div>
          <label for="manual-hour">Hora</label>
          <input type="number" id="manual-hour" name="manual_hour" min="0" max="23" placeholder="HH" required>
        </div>
        <div>
          <label for="manual-minute">Minutos</label>
          <input type="number" id="manual-minute" name="manual_minute" min="0" max="59" placeholder="MM" required>
        </div>
      </div>

      <label for="manual-kind">Tipo</label>
      <select id="manual-kind" name="manual_kind" required>
        <option value="IN">Entrada</option>
        <option value="OUT">Salida</option>
      </select>

      <p class="muted" style="margin-bottom: 0;">Este fichaje se registrará como WEB - MANUAL.</p>

      <div class="incident-actions">
        <button type="button" class="incident-cancel" data-close-modal="true">Cancelar</button>
        <button type="submit" class="incident-send">Enviar</button>
      </div>
      </form>
    </div>

    <button type="button" class="incident-type-btn wrong" data-form-target="wrong-form">Fichaje incorrecto</button>
    <div class="incident-form" id="wrong-form">
      <label for="wrong-description">Detalle</label>
      <textarea id="wrong-description" placeholder="Describe brevemente lo ocurrido..."></textarea>
      <div class="incident-actions">
        <button type="button" class="incident-cancel" data-close-modal="true">Cancelar</button>
        <button type="button" class="incident-send" data-send-demo="wrong">Enviar (demo)</button>
      </div>
    </div>

    <button type="button" class="incident-type-btn other" data-form-target="other-form">Otro motivo</button>
    <div class="incident-form" id="other-form">
      <label for="other-description">Detalle</label>
      <textarea id="other-description" placeholder="Cuéntanos el motivo..."></textarea>
      <div class="incident-actions">
        <button type="button" class="incident-cancel" data-close-modal="true">Cancelar</button>
        <button type="button" class="incident-send" data-send-demo="other">Enviar (demo)</button>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    function updateClock() {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const ss = String(now.getSeconds()).padStart(2, "0");
      const timeValue = `${hh}:${mm}:${ss}`;
      const heroClockEl = document.getElementById("hero-clock");
      if (heroClockEl) {
        heroClockEl.textContent = timeValue;
      }

      const clockEl = document.getElementById("live-clock");
      if (clockEl) {
        clockEl.textContent = timeValue;
      }

      const heroDateEl = document.getElementById("hero-date");
      if (heroDateEl) {
        const formattedDate = now.toLocaleDateString("es-ES", {
          weekday: "long",
          day: "2-digit",
          month: "long",
        });
        heroDateEl.textContent = formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);
      }
    }

    function updatePauseClock() {
      const pauseClockEl = document.getElementById("pause-live-time");
      if (!pauseClockEl) return;
      const [hh, mm, ss] = pauseClockEl.textContent.split(":").map((part) => Number(part || "0"));
      const totalSeconds = (hh * 3600) + (mm * 60) + ss + 1;
      const nextHh = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
      const nextMm = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
      const nextSs = String(totalSeconds % 60).padStart(2, "0");
      pauseClockEl.textContent = `${nextHh}:${nextMm}:${nextSs}`;
    }

    function themeIconSvg(themeName) {
      if (themeName === "dark") {
        return '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 3.5C13 4.8 12 6.8 12 9c0 3.9 3.1 7 7 7 0.6 0 1.3-0.1 1.9-0.3-1.2 3.1-4.2 5.3-7.7 5.3-4.6 0-8.4-3.8-8.4-8.4 0-4.1 2.9-7.5 6.8-8.3 1-0.2 2-0.2 2.9 0.2Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      }
      return '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="4.2" stroke="currentColor" stroke-width="1.8"/><path d="M12 2.8V5.1M12 18.9V21.2M21.2 12H18.9M5.1 12H2.8M18.5 5.5L16.9 7.1M7.1 16.9L5.5 18.5M18.5 18.5L16.9 16.9M7.1 7.1L5.5 5.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>';
    }

    function applyTheme(themeName) {
      document.documentElement.setAttribute("data-theme", themeName);
      window.localStorage.setItem("control-horario-theme", themeName);
      const themeIconEl = document.getElementById("theme-toggle-icon");
      const themeToggleBtn = document.getElementById("theme-toggle-btn");
      if (themeIconEl) {
        themeIconEl.innerHTML = themeIconSvg(themeName);
      }
      if (themeToggleBtn) {
        const nextModeLabel = themeName === "dark" ? "modo claro" : "modo oscuro";
        themeToggleBtn.setAttribute("title", `Cambiar a ${nextModeLabel}`);
        themeToggleBtn.setAttribute("aria-label", `Cambiar a ${nextModeLabel}`);
      }
    }

    const savedTheme = window.localStorage.getItem("control-horario-theme") || "light";
    applyTheme(savedTheme);

    const themeToggleBtn = document.getElementById("theme-toggle-btn");
    if (themeToggleBtn) {
      themeToggleBtn.addEventListener("click", () => {
        const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
        const nextTheme = currentTheme === "dark" ? "light" : "dark";
        applyTheme(nextTheme);
      });
    }

    updateClock();
    if (window.__clockInterval) {
      clearInterval(window.__clockInterval);
    }
    window.__clockInterval = setInterval(updateClock, 1000);

    if (window.__pauseClockInterval) {
      clearInterval(window.__pauseClockInterval);
    }
    window.__pauseClockInterval = setInterval(updatePauseClock, 1000);

    const reportModal = document.getElementById("report-modal");
    const openModalBtn = document.getElementById("open-report-modal");
    const closeModalBtn = document.getElementById("close-report-modal");

    function closeReportModal() {
      if (!reportModal) return;
      reportModal.classList.remove("is-open");
      reportModal.setAttribute("aria-hidden", "true");
    }

    function openReportModal() {
      if (!reportModal) return;
      reportModal.classList.add("is-open");
      reportModal.setAttribute("aria-hidden", "false");
    }

    function showIncidentForm(targetId) {
      document.querySelectorAll(".incident-form").forEach((form) => {
        form.classList.toggle("is-visible", form.id === targetId);
      });
    }

    if (openModalBtn) {
      openModalBtn.addEventListener("click", openReportModal);
    }

    if (closeModalBtn) {
      closeModalBtn.addEventListener("click", closeReportModal);
    }

    if (reportModal) {
      reportModal.addEventListener("click", (event) => {
        if (event.target === reportModal) {
          closeReportModal();
        }
      });
    }

    document.querySelectorAll("[data-form-target]").forEach((button) => {
      button.addEventListener("click", () => showIncidentForm(button.dataset.formTarget));
    });

    document.querySelectorAll("[data-close-modal='true']").forEach((button) => {
      button.addEventListener("click", closeReportModal);
    });

    document.querySelectorAll("[data-send-demo]").forEach((button) => {
      button.addEventListener("click", closeReportModal);
    });

    const manualDateInput = document.getElementById("manual-date");
    if (manualDateInput && !manualDateInput.value) {
      manualDateInput.value = new Date().toISOString().split("T")[0];
    }

    const manualForm = document.querySelector("#manual-form form");
    if (manualForm) {
      manualForm.addEventListener("submit", () => closeReportModal());
    }
  })();

  function confirmDimmedAction(event, action, isDimmed) {
    if (!isDimmed) {
      return true;
    }

    const stateEl = document.getElementById("punch-state");
    const currentState = stateEl ? stateEl.dataset.currentState : "";

    if (action === "in" && currentState === "ENTRADA") {
      const confirmed = window.confirm("Ya estás en ENTRADA. No deberías pulsar REGISTRAR ENTRADA. ¿Quieres continuar?");
      if (confirmed) {
        const input = event.target.querySelector('input[name="confirm_repeat"]');
        if (input) input.value = "1";
      }
      return confirmed;
    }

    if (action === "out" && currentState === "SALIDA") {
      const confirmed = window.confirm("Ya estás en SALIDA. No deberías pulsar REGISTRAR SALIDA. ¿Quieres continuar?");
      if (confirmed) {
        const input = event.target.querySelector('input[name="confirm_repeat"]');
        if (input) input.value = "1";
      }
      return confirmed;
    }

    return true;
  }
</script>
