{% extends "base.html" %}

{% block content %}
  <section class="card">
    {% include "employee/_sections.html" %}
    <div style="display:flex; justify-content:space-between; gap:1rem; align-items:flex-start; flex-wrap:wrap;">
      <div>
        <h1 style="margin-bottom:.25rem;">Historial</h1>
        <p class="muted" style="margin-top:0;">{{ employee.name }}</p>
      </div>
      <div class="month-nav">
        <a class="month-nav-btn" href="{{ url_for('employee.presence_control', month=prev_month) }}" aria-label="Mes anterior">&#9664;</a>
        <strong class="month-nav-label">{{ month_label }}</strong>
        {% if can_go_next_month %}
          <a class="month-nav-btn" href="{{ url_for('employee.presence_control', month=next_month) }}" aria-label="Mes siguiente">&#9654;</a>
        {% else %}
          <span class="month-nav-btn is-disabled" aria-label="Mes siguiente deshabilitado" aria-disabled="true">&#9654;</span>
        {% endif %}
      </div>
    </div>

    {% if active_shift %}
      <p class="muted" style="margin:.25rem 0 0;">
        Horas esperadas (turno {{ active_shift.name }}): {{ active_shift.expected_hours }} {{ active_shift_frequency }}
      </p>
    {% else %}
      <p class="muted" style="margin:.25rem 0 0;">Sin turno configurado. Se aplica el valor por defecto.</p>
    {% endif %}

    <p class="muted" style="margin-top:.2rem;">Trabajado {{ month_worked }} &middot; Esperado {{ month_expected }} &middot; Balance {{ month_balance }}</p>

    <table>
      <thead>
        <tr>
          <th>Dia</th>
          <th>Entradas/Salidas</th>
          <th>Trabajado</th>
          <th>Esperado</th>
          <th>Balance</th>
        </tr>
      </thead>
      <tbody>
        {% for row in month_rows %}
          <tr>
            <td>{{ row.day.strftime('%d/%m/%Y') }}</td>
            <td>
              {% if row.pairs %}
                {{ row.pairs|join(', ') }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>{% if row.is_open_day %}-{% else %}{{ minutes_to_hhmm(row.worked) }}{% endif %}</td>
            <td>{% if row.is_open_day %}-{% else %}{{ minutes_to_hhmm(row.expected) }}{% endif %}</td>
            <td>{% if row.is_open_day %}-{% else %}{{ minutes_to_hhmm(row.balance) }}{% endif %}</td>
          </tr>
        {% else %}
          <tr>
            <td colspan="5">Sin dias cerrados todavia para este mes.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <section class="card">
    <h2 style="margin-top:0;">Ultimos registros</h2>
    <table>
      <thead>
        <tr>
          <th>Fecha/Hora</th>
          <th>Tipo</th>
          <th>Origen</th>
          <th>Modo</th>
        </tr>
      </thead>
      <tbody>
        {% for event in recent_events %}
          <tr>
            <td>{{ to_app_tz(event.ts).strftime('%d/%m/%Y %H:%M:%S') }}</td>
            <td>{{ event.type.value }}</td>
            <td>{{ event.source.value }}</td>
            <td>{% if (event.meta_json or {}).get('manual') %}<strong>Manual</strong>{% else %}Normal{% endif %}</td>
          </tr>
        {% else %}
          <tr><td colspan="4">Sin registros todavia.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endblock %}
