{% extends "base.html" %}

{% block content %}
  {% include "employee/_sections.html" %}
  <section class="card">
    <h1>Solicitudes de vacaciones y permisos</h1>
    <p class="muted">{{ employee.name }}</p>
    {% if active_shift %}
      <p class="muted" style="margin-top:-.35rem;">Turno activo: {{ active_shift.name }}</p>
    {% else %}
      <p class="muted" style="margin-top:-.35rem;">Sin turno activo.</p>
    {% endif %}
    <p class="muted" style="margin-top:.1rem;">
      Permisos por horas: disponibles si la bolsa es de horas (usa mismo dia en desde/hasta y minutos).<br>
      MVP actual: corte de dia a las 00:00 en la zona horaria configurada; no soporta jornadas nocturnas.
    </p>
    <form method="post" enctype="multipart/form-data">
      {{ form.hidden_tag() }}
      <label for="{{ form.type_id.id }}">{{ form.type_id.label.text }}</label>
      {{ form.type_id() }}
      <label for="{{ form.date_from.id }}">Desde</label>
      {{ form.date_from() }}
      <label for="{{ form.date_to.id }}">Hasta</label>
      {{ form.date_to() }}
      <label for="{{ form.reason.id }}">Motivo</label>
      {{ form.reason(rows="3", placeholder="Describe el motivo de la ausencia...") }}
      <label for="{{ form.minutes.id }}">Minutos</label>
      {{ form.minutes() }}
      <label for="{{ form.attachment.id }}">Adjunto (PDF o imagen, max. 5MB)</label>
      {{ form.attachment(accept=".pdf,.jpg,.jpeg,.png,.webp") }}
      {% if available_policies %}
        <div style="margin-top: 1rem;">{{ form.submit() }}</div>
      {% else %}
        <p class="muted" style="margin-top:.75rem;">No hay vacaciones o permisos configurados para tu turno actual.</p>
        <div style="margin-top: 1rem;">{{ form.submit(disabled=true) }}</div>
      {% endif %}
    </form>
  </section>

  <section class="card">
    <h2>Historial</h2>
    <table>
      <thead>
        <tr>
          <th>Creada</th>
          <th>Tipo</th>
          <th>Desde</th>
          <th>Hasta</th>
          <th>Motivo</th>
          <th>Estado</th>
          <th>Comentario manager</th>
          <th>Adjunto</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for leave_request, leave_type in rows %}
          <tr>
            <td>{{ leave_request.created_at }}</td>
            <td>{{ leave_type.code }}</td>
            <td>{{ leave_request.date_from }}</td>
            <td>{{ leave_request.date_to }}</td>
            <td>{{ leave_request.reason }}</td>
            <td>{{ leave_status_labels.get(leave_request.status, leave_request.status.value) }}</td>
            <td>{{ leave_request.approver_comment or '-' }}</td>
            <td>
              {% if leave_request.attachment_name %}
                <a href="{{ url_for('employee.leave_attachment_download', leave_request_id=leave_request.id) }}">Descargar</a>
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if leave_request.status.value == "REQUESTED" %}
                <a class="secondary" style="display:inline-flex;align-items:center;padding:.4rem .6rem;border-radius:10px;" href="{{ url_for('employee.leave_edit', leave_request_id=leave_request.id) }}">Editar</a>
                <form class="inline" method="post" action="{{ url_for('employee.leave_cancel', leave_request_id=leave_request.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="danger">Cancelar</button>
                </form>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr><td colspan="9">Aun no hay solicitudes.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endblock %}
